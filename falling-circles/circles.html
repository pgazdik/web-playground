<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falling Circles</title>

    <style type="text/css">
        html,
        body,
        svg {
            width: 100%;
            height: 100%;
            margin: 0;
        }
    </style>

    <script>
        function initializeCircles() {
            const game = new Game();

            canvas.onmousedown = ev => game.mousedown(ev);
            canvas.onmouseup = ev => game.mouseup(ev);
            canvas.onmousemove = ev => game.mousemove(ev);
        }

        class Game {
            static RADIUS = 30;
            static MIN_DIST_SQUARE = 4 * Game.RADIUS * Game.RADIUS + 10;


            constructor() {
                this.lastX = -500;
                this.lastY = -500;
                this.mouseIsDown = false;
                this.canvasHeight = document.getRootNode().body.getBoundingClientRect().height;
                this.idCounter = 0;
                this.circles = {};
            }

            mousedown(ev) {
                this.mouseIsDown = true;
                this.newCircle(ev);
            }
            mouseup(ev) {
                this.mouseIsDown = false;
            }

            mousemove(ev) {
                if (this.mouseIsDown)
                    if (this.distSquare(this.lastX, this.lastY, ev.clientX, ev.clientY) > Game.MIN_DIST_SQUARE)
                        this.newCircle(ev);
            }

            distSquare(x0, y0, x, y) {
                const dx = x - x0;
                const dy = y - y0;
                return dx * dx + dy * dy;
            }

            newCircle(ev) {
                this.lastX = ev.clientX;
                this.lastY = ev.clientY;

                const circle = new FallingCircle(this, this.idCounter++, ev.clientX, ev.clientY, this.canvasHeight - Game.RADIUS);
                this.circles[circle.id] = circle;

                this.requestRedraw();
            }

            removeCircle(circle) {
                delete this.circles[circle.id]
            }

            requestRedraw() {
                requestAnimationFrame(this.update.bind(this));
            }

            update(timestamp) {
                canvas.innerHTML = "";
                for (const id in this.circles) {
                    const circle = this.circles[id];
                    circle.updateAndRender(timestamp);
                }
                this.requestRedraw();
            }

        }

        class FallingCircle {
            constructor(game, id, cx, cy, maxCy) {
                this.game = game;
                this.id = id;
                this.maxCy = maxCy;

                this.r = Game.RADIUS;

                this.cx = cx;
                this.cy = cy;
            }

            updateAndRender(timestamp) {
                if (!this.lastTimestamp) {
                    this.lastTimestamp = timestamp;
                }

                const timePassed = timestamp - this.lastTimestamp;
                this.lastTimestamp = timestamp;

                const ratio = timePassed / 50;

                this.cx += Math.floor(ratio * ((Math.random() * 7) - 2.5));
                this.cy += Math.floor(ratio * 4);

                if (this.cy < this.maxCy) {
                    const html = `<circle cx="${this.cx}" cy="${this.cy}" r="${this.r}" fill="yellow" />`
                    canvas.innerHTML += html;
                } else {
                    this.game.removeCircle(this);
                }
            }

        }

        window.addEventListener('load', initializeCircles)
    </script>
</head>

<body>
    <svg id="canvas" style="background-color:darkblue">
        <path id="moving-path" d="M 100 50 L 150 100 L 200 50 Z" stroke="green" stroke-width="5" fill-opacity="0"/>
        <!--circle cx="250" cy="0" r="40" fill="red"></circle-->
        <!-- circle id="xxx" cx="250" cy="0" r="40" stroke="black" stroke-width="3" fill="red" /-->
    </svg>
</body>

</html>


